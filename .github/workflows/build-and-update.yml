name: Build Zip and Update Metadata

on:
  push:
    branches:
      - main
    paths:
      - 'plugins/HotorNotAddon/**'

permissions:
  contents: write
  workflows: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------------------------------
      # Get commit info
      # ---------------------------------
      - name: Get commit info
        id: commit
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          COMMIT_DATE=$(git log -1 --format=%cd --date=format:'%Y-%m-%d')
          echo "sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "date=$COMMIT_DATE" >> $GITHUB_OUTPUT

      # ---------------------------------
      # Build zip directly into plugins/
      # ---------------------------------
      - name: Build HotorNotStats.zip
        run: |
          cd plugins
          zip -r HotorNotStats.zip HotorNotAddon

      # ---------------------------------
      # Calculate SHA256 of committed zip
      # ---------------------------------
      - name: Calculate SHA256
        id: hash
        run: |
          HASH=$(sha256sum plugins/HotorNotStats.zip | awk '{ print $1 }')
          echo "sha256=$HASH" >> $GITHUB_OUTPUT

      # ---------------------------------
      # Update static.yml
      # ---------------------------------
      - name: Update version, date, and sha256
        run: |
          FILE=".github/workflows/static.yml"

          sed -i "s/version:.*/version: 1.0${{ steps.commit.outputs.sha }}/" $FILE
          sed -i "s/date:.*/date: ${{ steps.commit.outputs.date }}/" $FILE
          sed -i "s/sha256:.*/sha256: ${{ steps.hash.outputs.sha256 }}/" $FILE

      # ---------------------------------
      # Commit changes
      # ---------------------------------
      - name: Commit updated files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add plugins/HotorNotStats.zip
          git add .github/workflows/static.yml

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-build zip and update metadata (1.0${{ steps.commit.outputs.sha }})"
            git push
          fi
